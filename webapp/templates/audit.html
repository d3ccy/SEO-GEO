{% extends "base.html" %}
{% block title %}GEO Audit — SEO-GEO Toolkit{% endblock %}

{% block content %}
<div class="page-header">
  <h1>GEO Audit</h1>
  <p class="subtitle">Audit a website&rsquo;s SEO and GEO readiness — no API credentials required</p>
</div>

<form method="POST" id="audit-form" class="form-card">
  {% if clients %}
  <div class="form-group">
    <label for="client-select">Load client profile</label>
    <select id="client-select" data-clients='{{ clients | tojson }}' data-target-field="url" data-domain-prefix="https://">
      <option value="">— Select a client —</option>
      {% for c in clients %}
        <option value="{{ c.id }}" data-domain="{{ c.domain }}">{{ c.name }}{% if c.domain %} ({{ c.domain }}){% endif %}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <div class="form-group">
    <label for="url">URL to audit <span class="required">*</span></label>
    <input type="url" id="url" name="url" value="{{ url_value }}" placeholder="https://example.com" required autocomplete="url">
  </div>

  <button type="submit" class="btn btn-primary" id="audit-submit">
    <span class="btn-text">Run Audit</span>
    <span class="btn-loading" hidden>Auditing&hellip;</span>
  </button>
</form>

{% if error %}
  <div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if result %}
<div class="results-section">
  <div class="results-header">
    <h2>Results for <a href="{{ result.url }}" target="_blank" rel="noopener">{{ result.url }}</a></h2>
    <div class="score-badge score-{% if result.score >= 71 %}green{% elif result.score >= 41 %}amber{% else %}red{% endif %}">
      GEO Score: {{ result.score }}/100
    </div>
  </div>

  {% if result.page_blocked %}
  <div class="alert alert-warn partial-results-banner">
    <strong>⚠ Partial results</strong> — This site's firewall (WAF) blocked access to the page HTML from the audit server.
    The on-page checks below (title, description, H1, schema) could not be completed.
    robots.txt and sitemap checks were still performed.<br>
    <small>{{ result.block_reason }}</small>
  </div>
  {% endif %}

  <table class="results-table">
    <thead>
      <tr><th>Check</th><th>Value</th><th>Status</th></tr>
    </thead>
    <tbody>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>Page Title</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.title or '—' }}{% if result.title %} <small>({{ result.title_length }} chars)</small>{% endif %}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.title and result.title_ok %}ok{% elif result.title %}warn{% else %}fail{% endif %}">
          {% if result.page_blocked %}— Blocked{% elif result.title and result.title_ok %}✓ Good{% elif result.title %}⚠ Too long (aim for &lt;60){% else %}✗ Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>Meta Description</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.description[:80] ~ '…' if result.description and result.description|length > 80 else result.description or '—' }}{% if result.description %} <small>({{ result.description_length }} chars)</small>{% endif %}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.description and result.description_ok %}ok{% elif result.description %}warn{% else %}fail{% endif %}">
          {% if result.page_blocked %}— Blocked{% elif result.description and result.description_ok %}✓ Good{% elif result.description %}⚠ Too long (aim for &lt;155){% else %}✗ Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>H1 Heading</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.h1 or '—' }}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.h1 %}ok{% else %}fail{% endif %}">
          {% if result.page_blocked %}— Blocked{% elif result.h1 %}✓ Present{% else %}✗ Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>OG Tags</td>
        <td></td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.og_tags %}ok{% else %}warn{% endif %}">
          {% if result.page_blocked %}— Blocked{% elif result.og_tags %}✓ Present{% else %}⚠ Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>JSON-LD Schema</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.jsonld_count }} block{% if result.jsonld_count != 1 %}s{% endif %}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.jsonld_count > 0 %}ok{% else %}fail{% endif %}">
          {% if result.page_blocked %}— Blocked{% elif result.jsonld_count > 0 %}✓ Present{% else %}✗ Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>Load Time</td>
        <td>{% if result.load_time is not none %}{{ result.load_time }}s{% else %}<em>Not measured</em>{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.load_time_ok %}ok{% else %}warn{% endif %}">
          {% if result.page_blocked %}— Blocked{% elif result.load_time_ok %}✓ Fast{% else %}⚠ Slow (aim for &lt;3s){% endif %}
        </td>
      </tr>
      <tr>
        <td>robots.txt</td>
        <td></td>
        <td class="status-{% if result.robots_exists %}ok{% else %}warn{% endif %}">
          {% if result.robots_exists %}✓ Found{% else %}⚠ Not found{% endif %}
        </td>
      </tr>
      <tr>
        <td>AI Bot Access</td>
        <td>{{ result.ai_bots | join(', ') if result.ai_bots else 'None mentioned' }}</td>
        <td class="status-{% if result.ai_bots %}ok{% else %}fail{% endif %}">
          {% if result.ai_bots %}✓ Mentioned{% else %}✗ Not mentioned in robots.txt{% endif %}
        </td>
      </tr>
      <tr>
        <td>Sitemap</td>
        <td></td>
        <td class="status-{% if result.has_sitemap %}ok{% else %}warn{% endif %}">
          {% if result.has_sitemap %}✓ Found at /sitemap.xml{% else %}⚠ Not found{% endif %}
        </td>
      </tr>
    </tbody>
  </table>

  <div class="score-legend">
    <span class="legend-item score-green">71–100: GEO Ready</span>
    <span class="legend-item score-amber">41–70: Needs Work</span>
    <span class="legend-item score-red">0–40: Poor</span>
  </div>

  <div class="report-download-section">
    <h3>Download Full Report</h3>
    <p>Generate a branded Word document with full analysis, recommendations, and the Princeton GEO method guide.</p>
    <form method="POST" action="/audit-report" id="report-form">
      <input type="hidden" name="url" value="{{ result.url }}">
      <div class="report-form-row">
        <div class="form-group">
          <label for="report-client-name">Client / Organisation name</label>
          <input type="text" id="report-client-name" name="client_name" placeholder="e.g. Still Water Grasmere" autocomplete="organization">
        </div>
        <div class="form-group">
          <label for="report-project-name">Project name <span class="optional">(optional)</span></label>
          <input type="text" id="report-project-name" name="project_name" placeholder="e.g. Website Relaunch 2026">
        </div>
      </div>
      <button type="submit" class="btn btn-secondary" id="report-submit">
        <span class="btn-text">⬇ Download GEO Audit Report (.docx)</span>
        <span class="btn-loading" hidden>Generating report&hellip;</span>
      </button>
    </form>
  </div>
</div>
{% endif %}
{% endblock %}
