{% extends "base.html" %}
{% block title %}GEO Audit â€” SEO-GEO Toolkit{% endblock %}

{% block content %}
<div class="page-header">
  <h1>GEO Audit</h1>
  <p class="subtitle">Audit a website&rsquo;s SEO and GEO readiness â€” no API credentials required</p>
</div>

{% include 'partials/how_to_audit.html' %}

<form method="POST" id="audit-form" class="form-card">
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
  {% if clients %}
  <div class="form-group">
    <label for="client-select">Load client profile</label>
    <select id="client-select" data-clients="{{ clients | tojson | e }}" data-target-field="url" data-domain-prefix="https://">
      <option value="">â€” Select a client â€”</option>
      {% for c in clients %}
        <option value="{{ c.id }}" data-domain="{{ c.domain }}" data-name="{{ c.name }}" data-project="{{ c.project_name or '' }}">{{ c.name }}{% if c.domain %} ({{ c.domain }}){% endif %}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <div class="form-group">
    <label for="url">URL to audit <span class="required">*</span></label>
    <input type="url" id="url" name="url" value="{{ url_value }}" placeholder="https://example.com" required autocomplete="url">
  </div>

  <div class="form-group stealth-toggle-group">
    <label class="checkbox-label stealth-label" for="use-stealth">
      <input type="checkbox" id="use-stealth" name="use_stealth" value="1"{% if use_stealth %} checked{% endif %}>
      <span class="stealth-label-text">
        <span class="stealth-label-title">ðŸ›¡ Cloudflare bypass mode</span>
        <span class="stealth-label-desc">Impersonates a real Chrome browser&rsquo;s TLS fingerprint â€” use when a site is protected by Cloudflare</span>
      </span>
    </label>
  </div>

  <input type="hidden" id="client_name" name="client_name" value="{{ audit_client_name }}">
  <input type="hidden" id="project_name" name="project_name" value="{{ audit_project_name }}">

  <button type="submit" class="btn btn-primary" id="audit-submit">
    <span class="btn-text">Run Audit</span>
    <span class="btn-loading" hidden>Auditing&hellip;</span>
  </button>
</form>

{% if error %}
  <div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if result %}
<div class="results-section">
  <div class="results-header">
    <h2>Results for <a href="{{ result.url }}" target="_blank" rel="noopener">{{ result.url }}</a></h2>
    <div class="results-header-badges">
      <div class="score-badge score-{% if result.score >= 71 %}green{% elif result.score >= 41 %}amber{% else %}red{% endif %}">
        GEO Score: {{ result.score }}/100
      </div>
      {% if result.use_stealth %}
      <div class="stealth-badge">ðŸ›¡ Cloudflare bypass</div>
      {% endif %}
    </div>
  </div>

  {% if result.page_blocked %}
  <div class="alert alert-warn partial-results-banner">
    <strong>âš  Partial results</strong> â€” This site's firewall (WAF) blocked access to the page HTML from the audit server.
    The on-page checks below (title, description, H1, schema) could not be completed.
    robots.txt and sitemap checks were still performed.<br>
    <small>{{ result.block_reason }}</small>
    {% if not result.use_stealth %}
    <br><br>
    <strong>ðŸ’¡ Tip:</strong> This site may be protected by Cloudflare.
    Try enabling <strong>Cloudflare bypass mode</strong> in the form above and re-running the audit.
    {% endif %}
  </div>
  {% endif %}

  <table class="results-table">
    <thead>
      <tr><th>Check</th><th>Value</th><th>Status</th></tr>
    </thead>
    <tbody>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>Page Title</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.title or 'â€”' }}{% if result.title %} <small>({{ result.title_length }} chars)</small>{% endif %}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.title and result.title_ok %}ok{% elif result.title %}warn{% else %}fail{% endif %}">
          {% if result.page_blocked %}â€” Blocked{% elif result.title and result.title_ok %}âœ“ Good{% elif result.title %}âš  Too long (aim for &lt;60){% else %}âœ— Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>Meta Description</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.description[:80] ~ 'â€¦' if result.description and result.description|length > 80 else result.description or 'â€”' }}{% if result.description %} <small>({{ result.description_length }} chars)</small>{% endif %}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.description and result.description_ok %}ok{% elif result.description %}warn{% else %}fail{% endif %}">
          {% if result.page_blocked %}â€” Blocked{% elif result.description and result.description_ok %}âœ“ Good{% elif result.description %}âš  Too long (aim for &lt;155){% else %}âœ— Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>H1 Heading</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.h1 or 'â€”' }}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.h1 %}ok{% else %}fail{% endif %}">
          {% if result.page_blocked %}â€” Blocked{% elif result.h1 %}âœ“ Present{% else %}âœ— Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>OG Tags</td>
        <td></td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.og_tags %}ok{% else %}warn{% endif %}">
          {% if result.page_blocked %}â€” Blocked{% elif result.og_tags %}âœ“ Present{% else %}âš  Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>JSON-LD Schema</td>
        <td>{% if result.page_blocked %}<em>Could not access page</em>{% else %}{{ result.jsonld_count }} block{% if result.jsonld_count != 1 %}s{% endif %}{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.jsonld_count > 0 %}ok{% else %}fail{% endif %}">
          {% if result.page_blocked %}â€” Blocked{% elif result.jsonld_count > 0 %}âœ“ Present{% else %}âœ— Missing{% endif %}
        </td>
      </tr>
      <tr {% if result.page_blocked %}class="row-blocked"{% endif %}>
        <td>Load Time</td>
        <td>{% if result.load_time is not none %}{{ result.load_time }}s{% else %}<em>Not measured</em>{% endif %}</td>
        <td class="status-{% if result.page_blocked %}blocked{% elif result.load_time_ok %}ok{% else %}warn{% endif %}">
          {% if result.page_blocked %}â€” Blocked{% elif result.load_time_ok %}âœ“ Fast{% else %}âš  Slow (aim for &lt;3s){% endif %}
        </td>
      </tr>
      <tr>
        <td>robots.txt</td>
        <td></td>
        <td class="status-{% if result.robots_exists %}ok{% else %}warn{% endif %}">
          {% if result.robots_exists %}âœ“ Found{% else %}âš  Not found{% endif %}
        </td>
      </tr>
      <tr>
        <td>AI Bot Access</td>
        <td>
          {% if result.ai_bots %}
            <span class="text-ok">âœ“ Allowed: {{ result.ai_bots | join(', ') }}</span>
            {% if result.ai_bots_blocked %}<br><small class="text-warn">âš  Blocked: {{ result.ai_bots_blocked | join(', ') }}</small>{% endif %}
          {% elif result.ai_bots_blocked %}
            <span class="text-warn">âš  Blocked: {{ result.ai_bots_blocked | join(', ') }}</span>
          {% else %}None explicitly configured{% endif %}
        </td>
        <td class="status-{% if result.ai_bots %}ok{% elif result.ai_bots_blocked %}warn{% else %}fail{% endif %}">
          {% if result.ai_bots %}âœ“ Allowed ({{ result.ai_bots | length }})
          {% elif result.ai_bots_blocked %}âš  Blocked in robots.txt
          {% else %}âœ— Not configured{% endif %}
        </td>
      </tr>
      <tr>
        <td>Sitemap</td>
        <td>{% if result.sitemap_url %}<small>{{ result.sitemap_url }}</small>{% endif %}</td>
        <td class="status-{% if result.has_sitemap %}ok{% else %}warn{% endif %}">
          {% if result.has_sitemap %}âœ“ Found{% else %}âš  Not found{% endif %}
        </td>
      </tr>
    </tbody>
  </table>

  <div class="score-legend">
    <span class="legend-item score-green">71â€“100: GEO Ready</span>
    <span class="legend-item score-amber">41â€“70: Needs Work</span>
    <span class="legend-item score-red">0â€“40: Poor</span>
  </div>

  {% if result.backlinks_rank or result.referring_domains or result.total_backlinks %}
  <div class="metric-cards-section">
    <h3 class="metric-cards-title">Domain Authority</h3>
    <div class="metric-cards">
      {% if result.backlinks_rank is not none %}
      <div class="metric-card">
        <div class="metric-value">{{ result.backlinks_rank }}</div>
        <div class="metric-label">Domain Rank</div>
      </div>
      {% endif %}
      {% if result.referring_domains is not none %}
      <div class="metric-card">
        <div class="metric-value">{{ "{:,}".format(result.referring_domains) }}</div>
        <div class="metric-label">Referring Domains</div>
      </div>
      {% endif %}
      {% if result.total_backlinks is not none %}
      <div class="metric-card">
        <div class="metric-value">{{ "{:,}".format(result.total_backlinks) }}</div>
        <div class="metric-label">Total Backlinks</div>
      </div>
      {% endif %}
    </div>
  </div>
  {% endif %}

  <div class="report-download-section">
    <h3>Download Full Report</h3>
    <p>Generate a branded Word document with full analysis, recommendations, and the Princeton GEO method guide.</p>
    <form method="POST" action="/audit-report" id="report-form">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="url" value="{{ result.url }}">
      <input type="hidden" name="use_stealth" value="{{ '1' if result.use_stealth else '0' }}">
      {% if audit_client_name %}
      {# Client was selected â€” pass data as hidden fields and show a read-only summary #}
      <input type="hidden" name="client_name" value="{{ audit_client_name }}">
      <input type="hidden" name="project_name" value="{{ audit_project_name }}">
      <div class="report-client-summary">
        <span class="report-client-label">Report for:</span>
        <span class="report-client-name">{{ audit_client_name }}</span>
        {% if audit_project_name %}<span class="report-project-name">{{ audit_project_name }}</span>{% endif %}
      </div>
      {% else %}
      {# No client selected â€” keep manual inputs as fallback #}
      <div class="report-form-row">
        <div class="form-group">
          <label for="report-client-name">Client / Organisation name</label>
          <input type="text" id="report-client-name" name="client_name" placeholder="e.g. Electoral Commission" autocomplete="organization">
        </div>
        <div class="form-group">
          <label for="report-project-name">Project name <span class="optional">(optional)</span></label>
          <input type="text" id="report-project-name" name="project_name" placeholder="e.g. Website Relaunch 2026">
        </div>
      </div>
      {% endif %}
      <button type="submit" class="btn btn-secondary" id="report-submit">
        <span class="btn-text">â¬‡ Download GEO Audit Report (.docx)</span>
        <span class="btn-loading" hidden>Generating report&hellip;</span>
      </button>
    </form>
  </div>
</div>
{% endif %}
{% endblock %}
