{% extends "base.html" %}
{% block title %}AI Visibility — SEO-GEO Toolkit{% endblock %}

{% block content %}
<div class="page-header">
  <h1>AI Visibility</h1>
  <p class="subtitle">See how AI platforms mention your brand — ChatGPT, Perplexity, Claude, Gemini</p>
</div>

<form method="POST" id="ai-vis-form" class="form-card">
  {% if clients %}
  <div class="form-group">
    <label for="client-select">Load client profile</label>
    <select id="client-select" data-clients='{{ clients | tojson }}' data-target-field="domain" data-domain-prefix="">
      <option value="">— Select a client —</option>
      {% for c in clients %}
        <option value="{{ c.id }}" data-domain="{{ c.domain }}">{{ c.name }}{% if c.domain %} ({{ c.domain }}){% endif %}</option>
      {% endfor %}
    </select>
  </div>
  {% endif %}

  <div class="form-group">
    <label for="domain">Domain <span class="required">*</span></label>
    <input type="text" id="domain" name="domain" value="{{ form.get('domain', '') }}" placeholder="e.g. numiko.com" required autocomplete="off">
  </div>
  <div class="form-group">
    <label for="brand_query">Brand / search query <span class="optional">(optional — auto-filled from domain)</span></label>
    <input type="text" id="brand_query" name="brand_query" value="{{ form.get('brand_query', '') }}" placeholder="e.g. Numiko digital agency">
  </div>

  <button type="submit" class="btn btn-primary" id="ai-vis-submit">
    <span class="btn-text">Check AI Visibility</span>
    <span class="btn-loading" hidden>Checking&hellip; (may take 20s)</span>
  </button>
</form>

{% if error %}
  <div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if result %}
<div class="results-section">
  <h2>AI Visibility for <strong>{{ result.domain }}</strong></h2>
  <p class="subtitle" style="margin-bottom:20px;">Query: &ldquo;{{ result.brand_query }}&rdquo;</p>

  {% if result.errors %}
  <div class="alert alert-warn">
    <strong>Note:</strong> Some checks could not complete (API access may be required):
    {% for err in result.errors %}<br><small>• {{ err }}</small>{% endfor %}
  </div>
  {% endif %}

  {# ── Panel 1: LLM Mentions ── #}
  <div class="section">
    <h2>LLM Mentions Overview</h2>
    {% if result.mentions is none %}
      <p class="empty-state">LLM Mentions data not available — requires AI Optimization API access.</p>
    {% elif result.mentions | length == 0 %}
      <p class="empty-state">No mentions found across LLM platforms for this domain.</p>
    {% else %}
    <div class="metric-cards">
      {% for platform in result.mentions %}
      <div class="metric-card">
        <div class="metric-value">{{ platform.mentions }}</div>
        <div class="metric-label">{{ platform.platform }}</div>
        {% if platform.sentiment %}
        <div class="metric-sub">
          <span class="intent-chip intent-{{ platform.sentiment }}">{{ platform.sentiment }}</span>
        </div>
        {% endif %}
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>

  {# ── Panel 2: ChatGPT Search ── #}
  <div class="section">
    <h2>ChatGPT Search Result</h2>
    {% if result.chatgpt is none %}
      <p class="empty-state">ChatGPT Search data not available — requires AI Optimization API access.</p>
    {% else %}
      {% if result.chatgpt.domain_mentioned %}
        <div class="alert" style="background:#EBFAF0;border:1px solid #a8dab5;color:#167832;margin-bottom:16px;">
          ✓ <strong>Your domain appears</strong> in ChatGPT's answer or cited sources.
        </div>
      {% else %}
        <div class="alert alert-warn">
          ✗ <strong>Your domain does not appear</strong> in this ChatGPT result.
        </div>
      {% endif %}

      {% if result.chatgpt.answer %}
      <div class="llm-answer-box">
        <p class="llm-answer-label">ChatGPT&rsquo;s answer to &ldquo;{{ result.brand_query }}&rdquo;:</p>
        <div class="llm-answer-text">{{ result.chatgpt.answer }}</div>
      </div>
      {% endif %}

      {% if result.chatgpt.sources %}
      <h3 style="font-size:14px;margin:16px 0 8px;font-weight:700;">Cited Sources ({{ result.chatgpt.sources | length }})</h3>
      <ul class="source-list">
        {% for source in result.chatgpt.sources %}
        <li>
          {% if source.url %}<a href="{{ source.url }}" target="_blank" rel="noopener">{% endif %}
          {{ source.title or source.url or source.domain }}
          {% if source.url %}</a>{% endif %}
          {% if source.domain %}<small class="text-muted"> — {{ source.domain }}</small>{% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endif %}
    {% endif %}
  </div>

  {# ── Panel 3: Multi-LLM Comparison ── #}
  <div class="section">
    <h2>Multi-LLM Comparison</h2>
    {% if result.llm_responses is none %}
      <p class="empty-state">Multi-LLM data not available — requires AI Optimization API access.</p>
    {% elif result.llm_responses | length == 0 %}
      <p class="empty-state">No LLM responses returned for this query.</p>
    {% else %}
    <div class="tab-nav" id="llm-tabs">
      {% for llm in result.llm_responses %}
      <button class="tab-btn{% if loop.first %} active{% endif %}" data-tab="llm-{{ loop.index }}">
        {{ llm.platform }}
        {% if llm.domain_mentioned %}<span class="tab-badge tab-badge-ok" title="Domain mentioned">✓</span>{% endif %}
      </button>
      {% endfor %}
    </div>
    {% for llm in result.llm_responses %}
    <div class="tab-panel{% if loop.first %} active{% endif %}" id="llm-{{ loop.index }}">
      {% if llm.domain_mentioned %}
      <div style="background:#EBFAF0;border:1px solid #a8dab5;color:#167832;padding:8px 12px;border-radius:5px;font-size:13px;margin-bottom:12px;">
        ✓ <strong>{{ result.domain }}</strong> is mentioned in this response.
      </div>
      {% endif %}
      <div class="llm-answer-box">
        <div class="llm-answer-text">{{ llm.response }}</div>
      </div>
    </div>
    {% endfor %}
    {% endif %}
  </div>

</div>
{% endif %}
{% endblock %}
